"use strict";var e=require("path"),r=require("@csstools/css-tokenizer"),s=require("@csstools/css-parser-algorithms");const t=/^([a-z0-9.+-]+:)?\/\//i;function rebase(r,s,o,i){if(r.startsWith("data:"))return!1;if(t.test(r))return!1;try{const e=new URL(r);if(e.port||e.protocol)return!1}catch{}const n=e.posix.resolve(e.posix.join(s.replace(new RegExp(`^${o}`),i),r));return e.posix.normalize(e.posix.relative(i,n))}function serializeString(e){let r="";for(const s of e){const e=s.codePointAt(0);if(void 0!==e)switch(e){case 0:r+=String.fromCodePoint(65533);break;case 127:r+=`\\${e.toString(16)}`;break;case 34:case 39:case 92:r+=`\\${s}`;break;default:if(1<=e&&e<=31){r+=`\\${e.toString(16)} `;break}r+=s}else r+=String.fromCodePoint(65533)}return r}const o=/url\(/i,i=/url/i,creator=()=>({postcssPlugin:"postcss-rebase-url",prepare(){const t=new WeakSet;return{Declaration(n,{result:a}){var u;if(t.has(n))return;const{from:l,to:p}=a.opts;if(!p||!l)return;if(null==(u=n.source)||!u.input.from)return;if(!o.test(n.value))return;const c=e.parse(e.resolve(p.trim())).dir.split(e.sep).join(e.posix.sep),f=e.parse(e.resolve(l.trim())).dir.split(e.sep).join(e.posix.sep),v=n.source.input.from.trim();if(!v)return;const d=e.parse(e.resolve(v)).dir.split(e.sep).join(e.posix.sep),m=s.parseCommaSeparatedListOfComponentValues(r.tokenize({css:n.value})),g=s.replaceComponentValues(m,(e=>{if(s.isTokenNode(e)&&e.value[0]===r.TokenType.URL){const r=rebase(e.value[4].value,d,f,c);if(r)return e.value[4].value=r,e.value[1]=`url(./${serializeString(r)})`,e}if(s.isFunctionNode(e)&&i.test(e.getName()))for(const t of e.value)if(!s.isWhitespaceNode(t)&&!s.isCommentNode(t)&&s.isTokenNode(t)&&t.value[0]===r.TokenType.String){const r=rebase(t.value[4].value,d,f,c);if(r)return t.value[4].value=r,t.value[1]=`"./${serializeString(r)}"`,e;break}})),k=s.stringify(g);k!==n.value&&(n.value=k,t.add(n))}}}});creator.postcss=!0,module.exports=creator;
