import e,{posix as t}from"path";import{tokenize as r,TokenType as s}from"@csstools/css-tokenizer";import{parseCommaSeparatedListOfComponentValues as o,replaceComponentValues as a,isTokenNode as i,isFunctionNode as n,isWhitespaceNode as l,isCommentNode as u,stringify as c}from"@csstools/css-parser-algorithms";const f=/^([a-z0-9.+-]+:)?\/\//i;function rebase(e,r,s,o){if(e.startsWith("data:"))return!1;if(f.test(e))return!1;try{const t=new URL(e);if(t.port||t.protocol)return!1}catch{}const a=t.join(r.replace(new RegExp(`^${s}`),o),e);return t.normalize(t.relative(o,a))}function serializeString(e){let t="";for(const r of e){const e=r.codePointAt(0);if(void 0!==e)switch(e){case 0:t+=String.fromCodePoint(65533);break;case 127:t+=`\\${e.toString(16)}`;break;case 34:case 39:case 92:t+=`\\${r}`;break;default:if(1<=e&&e<=31){t+=`\\${e.toString(16)} `;break}t+=r}else t+=String.fromCodePoint(65533)}return t}function toPosixPath(t){return t.split(e.sep).join(e.posix.sep)}const p=/url\(/i,v=/url/i,creator=()=>({postcssPlugin:"postcss-rebase-url",prepare(){const e=new WeakSet;return{Declaration(f,{result:d}){var m;if(e.has(f))return;const{from:g,to:P}=d.opts;if(!P||!g)return;const h=t.parse(toPosixPath(t.resolve(P))).dir,b=null==(m=f.source)?void 0:m.input.from;if(!b)return;const S=t.parse(toPosixPath(t.resolve(b))).dir,k=t.parse(toPosixPath(t.resolve(g))).dir;if(!p.test(f.value))return;const x=o(r({css:f.value})),z=a(x,(e=>{if(i(e)&&e.value[0]===s.URL){const t=rebase(e.value[4].value,S,k,h);if(t)return e.value[4].value=t,e.value[1]=`url(./${serializeString(t)})`,e}if(n(e)&&v.test(e.getName()))for(const t of e.value)if(!l(t)&&!u(t)&&i(t)&&t.value[0]===s.String){const r=rebase(t.value[4].value,S,k,h);if(r)return t.value[4].value=r,t.value[1]=`"./${serializeString(r)}"`,e;break}})),$=c(z);$!==f.value&&(f.value=$,e.add(f))}}}});creator.postcss=!0;export{creator as default};
