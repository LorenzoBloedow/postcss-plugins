import{posix as e}from"path";import{tokenize as r,TokenType as o}from"@csstools/css-tokenizer";import{parseCommaSeparatedListOfComponentValues as t,replaceComponentValues as s,isTokenNode as n,isFunctionNode as a,isWhitespaceNode as i,isCommentNode as l,stringify as c}from"@csstools/css-parser-algorithms";const u=/^([a-z0-9.+-]+:)?\/\//i;function rebase(r,o,t,s){if(r.startsWith("data:"))return!1;if(u.test(r))return!1;try{const e=new URL(r);if(e.port||e.protocol)return!1}catch{}const n=e.join(o.replace(new RegExp(`^${t}`),s),r);return e.normalize(e.relative(s,n))}function serializeString(e){let r="";for(const o of e){const e=o.codePointAt(0);if(void 0!==e)switch(e){case 0:r+=String.fromCodePoint(65533);break;case 127:r+=`\\${e.toString(16)}`;break;case 34:case 39:case 92:r+=`\\${o}`;break;default:if(1<=e&&e<=31){r+=`\\${e.toString(16)} `;break}r+=o}else r+=String.fromCodePoint(65533)}return r}const f=/url\(/i,v=/url/i,creator=()=>({postcssPlugin:"postcss-rebase-url",prepare(){const u=new WeakSet;return{Declaration(p,{result:g}){var m;if(u.has(p))return;const{from:d,to:b}=g.opts;if(!b||!d)return;const S=e.parse(e.resolve(b)).dir,k=null==(m=p.source)?void 0:m.input.from;if(!k)return;const h=e.parse(e.resolve(k)).dir,z=e.parse(e.resolve(d)).dir;if(console.log("----------------------"),console.log("toDir\n ",S),console.log("fromDir\n ",h),console.log("from\n ",k),console.log("fromEntryPointDir\n ",z),!f.test(p.value))return;const $=t(r({css:p.value})),P=s($,(e=>{if(n(e)&&e.value[0]===o.URL){const r=rebase(e.value[4].value,h,z,S);if(r)return e.value[4].value=r,e.value[1]=`url(./${serializeString(r)})`,e}if(a(e)&&v.test(e.getName()))for(const r of e.value)if(!i(r)&&!l(r)&&n(r)&&r.value[0]===o.String){const o=rebase(r.value[4].value,h,z,S);if(o)return r.value[4].value=o,r.value[1]=`"./${serializeString(o)}"`,e;break}})),w=c(P);w!==p.value&&(p.value=w,u.add(p))}}}});creator.postcss=!0;export{creator as default};
