import e,{posix as r}from"path";import{tokenize as o,TokenType as t}from"@csstools/css-tokenizer";import{parseCommaSeparatedListOfComponentValues as s,replaceComponentValues as i,isTokenNode as n,isFunctionNode as a,isWhitespaceNode as l,isCommentNode as u,stringify as c}from"@csstools/css-parser-algorithms";const f=/^([a-z0-9.+-]+:)?\/\//i;function rebase(e,o,t,s){if(e.startsWith("data:"))return!1;if(f.test(e))return!1;try{const r=new URL(e);if(r.port||r.protocol)return!1}catch{}const i=r.resolve(r.join(o.replace(new RegExp(`^${t}`),s),e));return r.normalize(r.relative(s,i))}function serializeString(e){let r="";for(const o of e){const e=o.codePointAt(0);if(void 0!==e)switch(e){case 0:r+=String.fromCodePoint(65533);break;case 127:r+=`\\${e.toString(16)}`;break;case 34:case 39:case 92:r+=`\\${o}`;break;default:if(1<=e&&e<=31){r+=`\\${e.toString(16)} `;break}r+=o}else r+=String.fromCodePoint(65533)}return r}function toPosix(r,o){if("win32"!==process.platform)return r;const t=e.resolve(r).split(e.sep).join(e.posix.sep),s="/"+o.split(e.posix.sep)[1]+"/";return!!t.includes(s)&&t.slice(t.indexOf(s))}const p=/url\(/i,v=/url/i,creator=()=>({postcssPlugin:"postcss-rebase-url",prepare(){const r=new WeakSet;return{Declaration(f,{result:m}){var g;if(r.has(f))return;const{from:d,to:x}=m.opts;if(!x||!d)return;if(null==(g=f.source)||!g.input.from)return;const b=e.posix.parse(e.posix.resolve(x.trim())).dir,S=e.posix.parse(e.posix.resolve(d.trim())).dir,k=toPosix(f.source.input.from.trim(),S);if(!k)return;const P=e.posix.parse(k).dir;if(console.log("----------------------"),console.log("toDir\n ",b),console.log("fromDir\n ",P),console.log("from\n ",k),console.log("fromEntryPointDir\n ",S),!p.test(f.value))return;const h=s(o({css:f.value})),z=i(h,(e=>{if(n(e)&&e.value[0]===t.URL){const r=rebase(e.value[4].value,P,S,b);if(r)return e.value[4].value=r,e.value[1]=`url(./${serializeString(r)})`,e}if(a(e)&&v.test(e.getName()))for(const r of e.value)if(!l(r)&&!u(r)&&n(r)&&r.value[0]===t.String){const o=rebase(r.value[4].value,P,S,b);if(o)return r.value[4].value=o,r.value[1]=`"./${serializeString(o)}"`,e;break}})),$=c(z);$!==f.value&&(f.value=$,r.add(f))}}}});creator.postcss=!0;export{creator as default};
