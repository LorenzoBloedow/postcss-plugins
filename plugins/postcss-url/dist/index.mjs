import{posix as e}from"path";import{tokenize as r,TokenType as t}from"@csstools/css-tokenizer";import{parseCommaSeparatedListOfComponentValues as s,replaceComponentValues as a,isTokenNode as o,isFunctionNode as l,isWhitespaceNode as u,isCommentNode as n,stringify as i}from"@csstools/css-parser-algorithms";const c=/^([a-z0-9.+-]+:)?\/\//i;function rebase(r,t,s,a){if(r.startsWith("data:"))return!1;if(c.test(r))return!1;try{const e=new URL(r);if(e.port||e.protocol)return!1}catch{}const{hash:o,search:l}=new URL(r,"https://example.com/"),u=e.resolve(e.join(t.replace(new RegExp(`^${s}`),a),r));return e.normalize(e.relative(a,u))+l+o}const p=/url\(/i,v=/url/i,creator=()=>({postcssPlugin:"postcss-url",prepare(){const c=new WeakSet;return{Declaration(f,{result:m}){var h;if(c.has(f))return;const{from:d,to:g}=m.opts;if(!g||!d)return;const b=e.parse(e.resolve(g)).dir,w=null==(h=f.source)?void 0:h.input.from;if(!w)return;const R=e.parse(e.resolve(w)).dir,k=e.parse(e.resolve(d)).dir;if(!p.test(f.value))return;const x=s(r({css:f.value})),z=a(x,(e=>{if(o(e)&&e.value[0]===t.URL){const r=rebase(e.value[4].value,R,k,b);if(r)return e.value[4].value=r,e.value[1]=`url(./${r.replaceAll(/"/g,"\\22").replaceAll(/'/g,"\\27")})`,e}if(l(e)&&v.test(e.getName()))for(const r of e.value)if(!u(r)&&!n(r)&&o(r)&&r.value[0]===t.String){const t=rebase(r.value[4].value,R,k,b);if(t)return r.value[4].value=t,r.value[1]='"./'+t.replaceAll(/"/g,'\\"')+'"',e;break}})),A=i(z);A!==f.value&&(f.value=A,c.add(f))}}}});creator.postcss=!0;export{creator as default};
